# root -> puller
#      -> C -> B
#      -> build-qux -> build-foo -> build-qaz
#      -> build-bar
stepTimeout: 600
totalTimeout: 900
push: [push1, push2, push3]

secrets:
  - akv: "someAKV"
    secretEnv: "someAkvSecretEnv"

steps:
  - id: puller
    run: azure/images/docker pull ubuntu
    entryPoint: someEntryPoint
    envs: [eric=foo, foo=bar]
    secretEnvs: [someAkvSecretEnv]
    exitedWithout: [0, 255]

  - id: build-qux
    run: azure/images/acr-builder build -f Dockerfile https://github.com/ehotinger/qux --cache-from=ubuntu
    when: ["-"]

  - id: C
    run: blah
    when: ["-"]
    exitedWith: [0, 1, 2, 3, 4]

  - id: build-bar
    run: azure/images/acr-builder build -f Dockerfile https://github.com/ehotinger/bar --cache-from=ubuntu
    when: ["-"]

  - id: B
    when: [C]
    run: azure/images/git clone https://github.com/ehotinger/clone

  - id: build-foo
    run: azure/images/acr-builder build -f Dockerfile https://github.com/ehotinger/foo --cache-from=ubuntu
    envs: ["eric=foo"]
    when: [build-qux]
    secretEnvs: [someAkvSecretEnv]

  - id: build-qaz
    run: "azure/images/acr-builder build -f Dockerfile https://github.com/ehotinger/qaz --cache-from=ubuntu"