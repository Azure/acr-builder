steps:
  - id: git-context
    run: build -f Dockerfile -t acr-builder:{{.Build.ID}} -t acr-builder:foo https://github.com/Azure/acr-builder.git
    rm: true

  - run: docker push {{.Build.Registry}}/acr-builder:latest
    rm: true

  - run: docker push {{.Build.Registry}}/acr-builder:{{.Build.ID}}
    rm: true

  - run: docker push {{.Build.Registry}}/acr-builder:foo
    rm: true

  - run: docker manifest create --amend {{.Build.Registry}}/acr-builder:latest {{.Build.Registry}}/acr-builder:{{.Build.ID}} {{.Build.Registry}}/acr-builder:foo
    rm: true

  - run: docker manifest annotate {{.Build.Registry}}/acr-builder:latest {{.Build.Registry}}/acr-builder:{{.Build.ID}} --os linux --arch amd64
    rm: true

  - run: docker manifest push {{.Build.Registry}}/acr-builder
    rm: true
